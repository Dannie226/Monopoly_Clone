import*as i from"three";import{GLTFLoader as e}from"three/examples/jsm/loaders/GLTFLoader";import{RGBELoader as t}from"three/examples/jsm/loaders/RGBELoader";import*as n from"../libs/tween";import{Player as u}from"./logic/Player";import{Globals as s}from"./logic/Globals";import{Dice as o}from"./logic/Dice";import{O_BUTTON as l,SQUARE_BUTTON as h,TRIANGLE_BUTTON as w,X_BUTTON as f}from"./logic/PS4Buttons";const{innerWidth:a,innerHeight:r}=window,y={async show(){},async hide(){}};{const M=document.createElementNS("http://www.w3.org/1999/xhtml","div"),P=(M.className="cover",M.style.backgroundColor="black",document.body.appendChild(M),new KeyframeEffect(M,[{width:"100%",height:"100%"},{width:"0px",height:"0px"}],{duration:1e3,easing:"ease-out",fill:"forwards"})),I=new KeyframeEffect(M,[{width:"0px",height:"0px"},{width:"100%",height:"100%"}],{duration:1e3,easing:"ease-in",fill:"forwards"});y.show=function(){const n=new Animation(P,document.timeline);return function(){return new Promise(t=>{n.addEventListener("finish",function e(){n.removeEventListener("finish",e),t()}),n.play()})}}(),y.hide=function(){const n=new Animation(I,document.timeline);return function(){return new Promise(t=>{n.addEventListener("finish",function e(){n.removeEventListener("finish",e),t()}),n.play()})}}()}const c=new i.WebGLRenderer,d=(c.setSize(a,r),c.setClearColor(12571109),document.getElementById("game").appendChild(c.domElement),new i.Scene),m=new i.PerspectiveCamera(75,a/r,100,3e3),p=(m.position.y=1e3,m.position.x=2e3,s.camera=m,new i.DirectionalLight),g=(d.add(p),new i.PMREMGenerator(c)),b={die:!1,board:!1,environment:!1,ran:!1},_=new e,v={tokens:{hat:null,iron:null,barrow:null,thimble:null},board:null};async function E(){if(1!=s.players.length){for(const n of s.players){async function t(e){e==l?await n.moveForward(await o.rollDice()):(await n.showStats(),n.awaitButtonPress([l,h]).then(t))}n.awaitButtonPress([l,h]).then(t)}E()}}async function k(){const e=document.getElementById("screens").children,c=(e[0].style.display="block",await T(1e3),await y.show(),await new Promise(n=>{const o=document.getElementsByClassName("numButton");function a(e){for(const t of o)t.removeEventListener("click",a);n(parseInt(e.target.innerHTML))}for(const e of o)e.addEventListener("click",a)})),d=(await y.hide(),e[0].style.display="none",e[1].style.display="block",await T(250),await y.show(),await new Promise(t=>{const n=document.getElementById("nameInput"),o=document.getElementById("submitName");let a=[];o.addEventListener("click",function e(){a.push(n.value),a.length==c&&(o.removeEventListener("click",e),t(a))})})),m=(await y.hide(),e[1].style.display="none",e[2].style.display="block",await T(250),await y.show(),await new Promise(t=>{let n=0;const o=[`Could ${d[0]} please connect their controller`,`Could ${d[1]} please connect their controller`,`Could ${d[2]} please connect their controller`,`Could ${d[3]} please connect their controller`],a=document.getElementById("connectTag");a.innerHTML=o[0],window.addEventListener("gamepadconnected",function e(){++n==c?(window.removeEventListener("gamepadconnected",e),t()):a.innerHTML=o[n]})}),["hat","iron","thimble","barrow"]),t=(await y.hide(),e[2].style.display="none",e[3].style.display="block",await T(250),await y.show(),s.players=await new Promise(a=>{const i=[],r=Array.from(document.getElementsByClassName("tokenImage"));let s=0;function l(e){const t=e.target;t.removeEventListener("click",l),r.splice(r.indexOf(t),1);e=t.alt;if(m.splice(m.indexOf(e),1),i.push(new u(s,d[s],v.tokens[e])),++s==c){for(const n of r)n.removeEventListener("click",l);for(const o of m)v.tokens[o].visible=!1;a(i)}}for(const e of r)e.addEventListener("click",l)}),await y.hide(),e[3].style.display="none",e[4].style.display="block",await T(250),await y.show(),document.getElementById("buttonTag"));var n={Circle:l,Triangle:w,Square:h,X:f},o=Object.keys(n);for(const i in s.players){const r=s.players[i];var a=o[4*Math.random()|0];t.innerHTML=`Could ${d[i]} please hit the ${a} button`,await r.awaitButtonPress(n[a])}await y.hide(),e[4].style.display="none",e[5].style.display="block",await T(250),await y.show(),await E()}_.load("../resources/models/die.glb",e=>{o.init();const t=e.scene.getObjectByName("Box001_Material_#25_0");t.geometry.center(),d.add(o.createDie(t).getMesh()),d.add(o.createDie().getMesh()),b.die=!0}),_.load("../resources/models/board.glb",e=>{const t=[];for(const o of["Top_Hat_09_-_Default_0","Iron_09_-_Default_0","Wheel_Barrow_09_-_Default_0","Thimble_09_-_Default_0"]){const a=e.scene.getObjectByName(o);a.geometry.rotateX(-Math.PI/2),a.geometry.rotateY(Math.PI/2),d.add(a),t.push(a)}v.tokens.hat=t[0],v.tokens.iron=t[1],v.tokens.barrow=t[2],v.tokens.thimble=t[3],v.tokens.barrow.visible=v.tokens.thimble.visible=!1,m.position.set(0,975,0),m.quaternion.set(-Math.SQRT1_2,0,0,Math.SQRT1_2),v.board=e.scene.getObjectByName("Board_01_-_Default_0"),v.board.geometry.rotateX(-Math.PI/2),v.board.position.y=-5,d.add(v.board);const n=e.scene.getObjectByName("House_07_-_Default_0");n.geometry.rotateX(-Math.PI/2),n.geometry.scale(1/3,1/3,1/3),s.houseMesh=new i.InstancedMesh(n.geometry,n.material,112),s.houseMesh.instanceMatrix.setUsage(i.DynamicDrawUsage),d.add(s.houseMesh),b.board=!0});const B=new t;function L(){n.update(),o.update(),c.render(d,m),b.die&&b.board&&b.environment&&!b.ran&&(b.ran=!0,k()),requestAnimationFrame(L)}function T(t){return new Promise(e=>{setTimeout(e,t)})}B.load("https://threejs.org/examples/textures/equirectangular/pedestrian_overpass_1k.hdr",function(e){d.environment=g.fromEquirectangular(e).texture,b.environment=!0}),L();